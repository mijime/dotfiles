#!/bin/bash

ssh_cmd=ssh
ssh_options=(-t)

while true
do
  case $1 in
    -p|--port)
      open_port=$2
      shift 2 || exit 2
      ;;
    -d|--dry-run)
      dry_run=1
      shift || exit 2
      ;;
    -S|--sudo)
      ssh_cmd='sudo ssh'
      shift || exit 2
      ;;
    -F|-i|-L)
      first_ssh_options=(${first_ssh_options[@]} $1 $2)
      shift 2 || exit 2
      ;;
    -*)
      ssh_options=(${ssh_options[@]} $1)
      shift || exit 2
      ;;
    *)
      hosts=(${hosts[@]} $1)
      shift || break
      ;;
  esac
done

open_port=${open_port:-22}
host_num=${#hosts[@]}
next_port=${open_port}
next_port_init=$(expr ${open_port} + 10000)

n=0
for host in ${hosts[@]}; do
    prev_next_port=${next_port}
    n=$(expr ${n} + 1)
    if [[ ${n} -eq ${host_num} ]]
        then next_port=${open_port}
        else next_port=$(expr ${n} + ${next_port_init})
    fi

    all_cmd="${all_cmd} ${ssh_cmd} ${first_ssh_options[@]} ${verbose} ${ssh_options[@]} -L 0.0.0.0:${prev_next_port}:0.0.0.0:${next_port} ${host}"
    unset first_ssh_options
done

if [ -z ${dry_run} ]
then ${all_cmd}
else cat <<EOF
${all_cmd}
EOF
fi

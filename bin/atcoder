#!/usr/bin/env bash

set -euo pipefail

list_contests() {
  curl -sSL "https://atcoder.jp/contests" |
    go-queryh \
      -query "#contest-table-${contest_status} table > tbody > tr > td:nth-child(2) a" --attr href
}

download_contest() {
  if [[ ! -f "${base_dir}/contests/${contest_id}/tasks/index.html" ]]; then
    mkdir -p "${base_dir}/contests/${contest_id}/tasks"
    curl -sSL "https://atcoder.jp/contests/${contest_id}/tasks" -o "${base_dir}/contests/${contest_id}/tasks/index.html"
    echo "download https://atcoder.jp/contests/${contest_id}/tasks"
  else
    echo "already downloaded https://atcoder.jp/contests/${contest_id}/tasks"
  fi

  go-queryh \
    -query ".row table tbody tr td:nth-child(2)" \
    <"${base_dir}/contests/${contest_id}/tasks/index.html" |
    while read -r anchor; do
      href="$(echo "${anchor}" | go-queryh -query a -attr href)"
      download_contest_task "${base_dir}${href}" "https://atcoder.jp${href}"
    done
}

download_contest_task() {
  mkdir -p "${1}/test"
  if [[ ! -f "${1}/index.html" ]]; then
    curl -sSL "${2}" -o "${1}/index.html"
    echo "download $2"
  else
    echo "already downloaded $2"
  fi

  : >"${1}/question.txt"
  for no in $(seq 1 20); do
    section=$(
      go-queryh \
        -query "#task-statement .lang-ja .part:nth-child($no) section" \
        <"${1}/index.html"
    )
    title=$(echo "${section}" | go-queryh -query h3 -attr text)
    case ${title} in
    問題文* | 制約 | 入力)
      {
        echo "${section}" | html2text
        echo
      } >>"${1}/question.txt"
      ;;
    入力例\ *)
      echo "${section}" | go-queryh -query pre -attr text >"${1}/test/sample-${title#*\ }.in"
      ;;
    出力例\ *)
      echo "${section}" | go-queryh -query pre -attr text >"${1}/test/sample-${title#*\ }.out"
      ;;
    esac
  done
}

test_contest_task() {
  for input in $(find "${1}" -type f -name "sample-*.in" | sort -n); do
    if [[ ! -s "${input}" ]] || [[ $(wc -l <"${input}") -eq 0 ]]; then
      return
    fi

    output=${input%.in}.out
    if diff -ur "${output}" <(${test_cmd[@]} <"${input}"); then
      echo "succeed ${input}"
    else
      echo "failed ${input}"
    fi
  done
}

base_dir=${ATCODER_BASE_DIR:-~/src/atcoder.jp}
test_cmd=${ATCODER_TEST_CMD:-./a.out}
contest_status=recent
while [[ $# -gt 0 ]]; do
  case ${1} in
  -b | --base_dir)
    base_dir=${2}
    shift
    ;;
  -c | --contest)
    contest_id=${2}
    shift
    ;;
  -t | --task)
    task_id=${2}
    shift
    ;;
  --upcoming)
    contest_status=upcoming
    ;;
  --test)
    test_cmd=${2}
    shift
    ;;
  -*)
    echo "unsupported: $*" >&2
    exit 1
    ;;
  *)
    cmd=$1
    ;;
  esac
  shift
done

case ${cmd} in
l | list)
  list_contests
  ;;
d | download)
  download_contest
  ;;
dt | download-task)
  download_contest_task "${base_dir}/contests/${task_id}" "https://atcoder.jp/contests/${task_id}"
  ;;
t | test)
  test_contest_task "$(pwd)"
  ;;
*)
  echo "unsupported cmd: ${cmd}" >&2
  exit 1
  ;;
esac

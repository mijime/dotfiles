#!/usr/bin/env bash

set -euo pipefail

list_contests() {
  curl -sSL "https://atcoder.jp/contests" |
    go-queryh \
      -query '#contest-table-recent > div > div > table > tbody > tr > td:nth-child(2) a' --attr href
}

download_contest() {
  curl -sSL "https://atcoder.jp/contests/${contest}/tasks" |
    go-queryh \
      -query ".row table tbody tr td:nth-child(2)" |
    while read -r anchor; do
      href="$(echo "${anchor}" | go-queryh -query a -attr href)"
      mkdir -p "${base_dir}${href}"
      download_contest_task "${base_dir}${href}" "https://atcoder.jp${href}"
    done
}

download_contest_task() {
  if [[ ! -f "${1}/index.html" ]]; then
    curl -sSL "${2}" -o "${1}/index.html"
    echo "download $2"
  else
    echo "already downloaded $2"
  fi

  parse_question "${1}"

  for no in $(seq 1 3); do
    parse_sample_testcase "${1}" "${no}"
  done
}

parse_question() {
  go-queryh \
    -query '#task-statement .lang-ja .part:nth-child(-n+6)' \
    -attr text \
    <"${1}/index.html" \
    >"${1}/question.txt"
}

parse_sample_testcase() {
  mkdir -p "${1}/test/"

  go-queryh -query "#task-statement .lang-ja .part:nth-child(n+7) section" \
    <"${1}/index.html" |
    go-queryh -query "section:nth-child($((${2} * 2 - 1))) pre" \
      -attr text \
      >"${1}/test/sample-${2}.in"
  go-queryh -query "#task-statement .lang-ja .part:nth-child(n+7) section" \
    <"${1}/index.html" |
    go-queryh -query "section:nth-child($((${2} * 2))) pre" \
      -attr text \
      >"${1}/test/sample-${2}.out"
}

test_contents_task() {
  for no in $(seq 1 3); do
    if [[ ! -s "${1}/test/sample-${no}.in" ]] || [[ $(wc -l <"${1}/test/sample-${no}.in") -eq 0 ]]; then
      return
    fi

    if diff -ur <(${test_cmd[@]} <"${1}/test/sample-${no}.in") "${1}/test/sample-${no}.out"; then
      echo "succeed test/sample-${no}.in"
    else
      echo "failed test/sample-${no}.in"
    fi
  done
}

base_dir=${ATCODER_BASE_DIR:-~/src/atcoder.jp}
test_cmd=${ATCODER_TEST_CMD[@]}
cmd=list
while [[ $# -gt 0 ]]; do
  case ${1} in
  -b | --base_dir)
    base_dir=${2}
    shift
    ;;
  -c | --contest)
    contest=${2}
    shift
    ;;
  -t | --test)
    test_cmd=${2}
    shift
    ;;
  list | download | test)
    cmd=$1
    ;;
  *)
    echo "unsupported: $*" >&2
    exit 1
    ;;
  esac
  shift
done

case ${cmd} in
list)
  list_contests
  ;;
download)
  download_contest
  ;;
test)
  test_contents_task "$(pwd)"
  ;;
esac

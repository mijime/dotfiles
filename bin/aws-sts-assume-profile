#!/usr/bin/env bash

set -ue

aws_profile=
while [[ $# -gt 0 ]]
do
  case $1 in
    --profile)
      aws_profile=$2
      shift 2
      ;;
    --profile=*)
      aws_profile=${1#*=}
      shift
      ;;
    *)
      printf "unsupport: %s" "$*" >&2
      exit 2
      ;;
  esac
done

role_session_name="$(whoami)"
role_arn=$(aws configure get role_arn --profile "${aws_profile}")
mfa_serial=$(aws configure get mfa_serial --profile "${aws_profile}")

printf "%s MFA Code: " "${mfa_serial}" >&2
read -r token_code

aws sts assume-role \
  --query "Credentials" \
  --output "json" \
  --role-arn "${role_arn}" \
  --serial-number "${mfa_serial}" \
  --role-session-name "${role_session_name}" \
  --token-code "${token_code}"

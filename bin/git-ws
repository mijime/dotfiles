#!/usr/bin/env bash

set -ueo pipefail

git_dir=${GIT_WS_DIR:-"$(git rev-parse --show-toplevel)"}
git_dir=${git_dir%.workspace}
git_ws_dir=${git_dir}.workspace
git_ws_subdir=$(date +"${GIT_WS_DIR_FMT:-"src/%Y/%m/%d"}")

act=init
act_target=
while [[ $# -gt 0 ]]; do
  case $1 in
  edit)
    act=edit
    act_target=${2:-"${git_ws_subdir}/${GIT_WS_INDEX_MD:-index.md}"}
    break
    ;;
  sh | shell)
    act=shell
    act_target=${2:-"${git_ws_subdir}"}
    break
    ;;
  *)
    act=$1
    shift || true
    act_target=$*
    break
    ;;
  esac
  shift
done

case ${act} in
init)
  git init "${git_ws_dir}"
  ;;
pwd)
  echo "${git_dir}"
  ;;
shell)
  cd "${git_ws_dir}/${act_target}"
  GIT_WS_DIR=${git_ws_dir} PATH="${PATH}:${git_ws_dir}/bin" ${GIT_WS_SHELL_CMD:-${SHELL}}

  cd "${git_ws_dir}"
  git add "${act_target}"
  echo "# Update ${act_target}" >"${git_ws_dir}/.git/COMMIT_EDITMSG.tmpl"
  git commit --template="${git_ws_dir}/.git/COMMIT_EDITMSG.tmpl" || true
  ;;
edit)
  mkdir -p "$(dirname "${git_ws_dir}/${act_target}")"
  ${EDITOR:-vim} "${git_ws_dir}/${act_target}"

  cd "${git_ws_dir}"
  git add "${act_target}"
  echo "# Update ${act_target}" >"${git_ws_dir}/.git/COMMIT_EDITMSG.tmpl"
  git commit --template="${git_ws_dir}/.git/COMMIT_EDITMSG.tmpl" || true
  ;;
log)
  cd "${git_ws_dir}"
  git log ${act_target[@]}
  ;;
ls-files)
  cd "${git_ws_dir}"
  git ls-files ${act_target[@]}
  ;;
*)
  echo "$0: unsupported command: ${act}" >&2
  exit 1
  ;;
esac

#!/usr/bin/env bash

set -Eeuo pipefail

beareq_cache_key=$(date +%F)
beareq_with_cache() {
  cache_file="/tmp/$(basename "$0")-$(echo "$* ${beareq_cache_key}" | md5sum | awk '{print$1}').dat"
  if [[ ! -f "${cache_file}" ]]; then
    beareq "${@}" >"${cache_file}"
  fi
  cat "${cache_file}"
}

gtasks_tasklist() {
  beareq_with_cache --profile="${google_profile}" \
    "https://tasks.googleapis.com/tasks/v1/users/@me/lists" |
    jq -rc '.items[] | [.id,.title] | @tsv'
}

gtasks_list() {
  query="showCompleted=${gtasks_list__show_completed}"
  if [[ -n ${gtasks_list__due_max} ]]; then
    query="${query}&dueMax=${gtasks_list__due_max}"
  fi
  if [[ -n ${gtasks_list__due_min} ]]; then
    query="${query}&dueMin=${gtasks_list__due_min}"
  fi
  if [[ -n ${gtasks_list__completed_max} ]]; then
    query="${query}&completedMax=${gtasks_list__completed_max}"
  fi
  if [[ -n ${gtasks_list__completed_min} ]]; then
    query="${query}&completedMin=${gtasks_list__completed_min}"
  fi
  beareq --profile="${google_profile}" \
    "https://tasks.googleapis.com/tasks/v1/lists/${google_tasklist}/tasks?${query}" |
    jq -rc '.items[] | [.id,.due,.title] | @tsv'
}

gtasks_add() {
  due=${due:-$(date --rfc-3339=seconds --date "7days" | sed -e 's/ /T/')}
  req="{\"title\":\"${title}\",\"notes\":\"\",\"due\":\"${due}\"}"

  if [[ -n ${is_edit} ]] || [[ -z ${title} ]]; then
    tmpfile=$(mktemp --suffix=.toml)
    trap 'rm ${tmpfile}' EXIT

    echo "${req}" | yj -jt >"${tmpfile}"
    ${EDITOR:-vim} "${tmpfile}"
    req=$(yj -tj <"${tmpfile}")
  fi

  beareq \
    --profile="${google_profile}" \
    --header="Content-type: application/json" \
    --request="POST" \
    --data="${req}" \
    "https://tasks.googleapis.com/tasks/v1/lists/${google_tasklist}/tasks" |
    jq -rS
}

gtasks_show() {
  beareq --profile="${google_profile}" \
    "https://tasks.googleapis.com/tasks/v1/lists/${google_tasklist}/tasks/${task}" |
    jq -rS
}

gtasks_delete() {
  beareq --profile="${google_profile}" \
    --request="DELETE" \
    "https://tasks.googleapis.com/tasks/v1/lists/${google_tasklist}/tasks/${task}" |
    jq -rS
}

gtasks_patch() {
  beareq --profile="${google_profile}" \
    --header="Content-type: application/json" \
    --request="PATCH" \
    --data="$*" \
    "https://tasks.googleapis.com/tasks/v1/lists/${google_tasklist}/tasks/${task}" |
    jq -rS
}

gtasks_update() {
  beareq --profile="${google_profile}" \
    --header="Content-type: application/json" \
    --request="PUT" \
    --data="$*" \
    "https://tasks.googleapis.com/tasks/v1/lists/${google_tasklist}/tasks/${task}" |
    jq -rS
}

gtasks_edit() {
  req=$(gtasks_show)

  tmpfile=$(mktemp --suffix=.toml)
  trap 'rm ${tmpfile}' EXIT

  echo "${req}" | yj -jt >"${tmpfile}"
  ${EDITOR:-vim} "${tmpfile}"
  req=$(yj -tj <"${tmpfile}")

  gtasks_update "${req}"
}

gtasks_done() {
  gtasks_patch "{\"status\":\"completed\"}"
}

google_profile=${GTASKS_GOOGLE_BEAREQ_PROFILE:-${GOOGLE_BEAREQ_PROFILE:-"default"}}
google_tasklist=${GTASKS_GOOGLE_TASKLIST:-${GOOGLE_TASKLIST:-""}}
task=
title=
due=
cmd=list
is_edit=1
gtasks_list__show_completed=false
gtasks_list__due_max=
gtasks_list__due_min=
gtasks_list__completed_max=
gtasks_list__completed_min=

while [[ $# -gt 0 ]]; do
  case $1 in
  --profile) google_profile=$2 && shift ;;
  --profile=*) google_profile=${1#*=} ;;
  --tasklist) google_tasklist=$2 && shift ;;
  --tasklist=*) google_tasklist=${1#*=} ;;
  --task) task=$2 && shift ;;
  --task=*) task=${1#*=} ;;
  --title) title=$2 && shift ;;
  --title=*) title=${1#*=} ;;
  --due) due=$(date +"%FT%TZ" --utc --date "$2") && shift ;;
  --due=*) due=$(date +"%FT%TZ" --utc --date "${1#*=}") ;;
  --edit) is_edit=1 ;;
  --no-edit) is_edit= ;;
  --completed) gtasks_list__show_completed=true ;;
  --due-max) gtasks_list__due_max=$(date +"%FT%TZ" --utc --date "$2") && shift ;;
  --due-min) gtasks_list__due_min=$(date +"%FT%TZ" --utc --date "$2") && shift ;;
  --completed-max) gtasks_list__show_completed=true && gtasks_list__completed_max=$(date +"%FT%TZ" --utc --date "$2") && shift ;;
  --completed-min) gtasks_list__show_completed=true && gtasks_list__completed_min=$(date +"%FT%TZ" --utc --date "$2") && shift ;;
  tasklist | add | list | edit | show | delete | done) cmd=$1 ;;

  *)
    echo "unsupport args: $*" >&2
    exit 1
    ;;
  esac
  shift
done

case ${cmd} in
tasklist)
  gtasks_tasklist
  exit
  ;;
esac

if [[ -z ${google_tasklist} ]]; then
  resp=$(gtasks_tasklist)
  google_tasklist=$(echo "${resp}" | fzf --select-1 | awk -F"\t" '{print$1}')
fi

case ${cmd} in
add)
  gtasks_add
  exit
  ;;

list)
  gtasks_list
  exit
  ;;
esac

if [[ -z "${task}" ]]; then
  resp=$(gtasks_list)
  task=$(echo "${resp}" | fzf --select-1 | awk -F"\t" '{print$1}')
fi

if [[ -z "${cmd}" ]]; then
  cmd=$(echo -e "show\nedit\ndone\ndelete\n" | fzf)
fi

case ${cmd} in
edit) gtasks_edit ;;
done) gtasks_done ;;
show) gtasks_show ;;
delete) gtasks_delete ;;
esac

#!/usr/bin/env bash

set -ue

pgpass_dir=${HOME}/.pgpass.d
pgpass=${HOME}/.pgpass

function __crypt {
  mode=decrypt
  encrypted=
  decrypted=

  while [[ $# -gt 0 ]]
  do
    case $1 in
      --save)
        mode=encrypt
        shift
        ;;
      --load)
        mode=decrypt
        shift
        ;;
      --dec=*)
        decrypted=${1#*=}
        shift
        ;;
      --enc=*)
        encrypted=${1#*=}
        shift
        ;;
      *)
        encrypted=$1
        shift
        ;;
    esac
  done

  if [[ -z $encrypted ]] || [[ -z $decrypted ]]
  then
    printf "[ERROR] please set encrypted filepath and decrypted filepath\n" >&2
    return 2
  fi

  case ${mode} in
    decrypt)
      openssl aes-256-cbc -d -in "${encrypted}" -out "${decrypted}"
      ;;

    encrypt)
      openssl aes-256-cbc -e -in "${decrypted}" -out "${encrypted}"
      ;;
  esac
}

function __psql_overssh {
  sql_mode=connect
  conf_name=
  use_config=1

  ssh_options=
  dsn=

  while [[ $# -gt 0 ]]
  do
    case $1 in
      --name=*|--config=*)
        conf_name=${1#*=}
        shift
        ;;
      --ssh=*|--ssh-options=*)
        ssh_options=${1#*=}
        shift
        ;;
      --dsn=*)
        dsn=${1#*=}
        shift
        ;;
      --save)
        sql_mode=save
        shift
        ;;
      --load)
        sql_mode=load
        shift
        ;;
      -h|--help)
        sql_mode=help
        shift
        ;;
      --current)
        use_config=
        shift
        ;;
      *)
        break
        ;;
    esac
  done

  if [[ -n $conf_name ]] && [[ ! -f $conf_name ]]
  then conf_name=${pgpass_dir}/${conf_name}
  fi

  case ${sql_mode} in
    help)
      cat <<EOS
USAGE
===

$0 --config=testdb
$0 --config=testdb --save
$0 --config=testdb --load
$0 --current
EOS

      ;;
    save)
      if [[ ! -f ${pgpass} ]]
      then
        printf "[ERROR] not found config file: %s\n" "$pgpass" >&2
        return 2
      fi

      __crypt --save --enc="${conf_name}" --dec="${pgpass}"
      chmod 0600 "${conf_name}"
      ;;

    load)
      if [[ ! -f ${conf_name} ]]
      then
        printf "[ERROR] not found config file: %s\n" "$conf_name" >&2
        return 2
      fi

      __crypt --load --enc="${conf_name}" --dec="${pgpass}"
      chmod 0600 "${pgpass}"
      ;;

    connect)
      if [[ ! -f ${conf_name} ]] && [[ -n ${use_config} ]]
      then
        printf "[ERROR] not found config file: %s\n" "$conf_name" >&2
        return 2
      fi

      if [[ -n ${use_config} ]]
      then
        __crypt --load --enc="${conf_name}" --dec="${pgpass}"
        chmod 0600 "${pgpass}"
      fi

      if [[ -f ${pgpass} ]]
      then
        ssh_options="$(awk -F' *### *' '$2=="SSH"{print$NF;exit}' < "${pgpass}")"
        dsn="$(awk -F' *### *' '$2=="DSN"{print$NF;exit}' < "${pgpass}")"
      fi

      if [[ -z $ssh_options ]]
      then
        psql "${dsn}" "${@}" || true
      else
        ssh -N ${ssh_options} &
        ssh_pid=$!
        trap 'kill "${ssh_pid}"' HUP INT QUIT
        sleep 1
        psql "${dsn}" "${@}" || true
        kill "${ssh_pid}"
      fi
      ;;
  esac
}

__psql_overssh "${@}"
